"""Define the structure of the data generated by an experiment."""

from dataclasses import field
from pathlib import Path
from typing import List, Tuple, Union

from pydantic import ConfigDict, RootModel
from pydantic.dataclasses import dataclass

from panda_lib.sql_tools.db_setup import SessionLocal
from panda_lib.sql_tools.panda_models import (
    ExperimentResults,
)


class ExperimentResultsRecord:
    """
    A class for representing a single entry in a result table.
    The table has columns:
    id,
    experiment_id,
    result_type,
    result_value
    """

    def __init__(
        self, experiment_id: int, result_type: str, result_value: str, context=None
    ):
        self.experiment_id = experiment_id
        self.result_type = result_type
        self.result_value = result_value
        self.context = context

    def __str__(self):
        return f"Experiment ID: {self.experiment_id}, Result Type: {self.result_type}, Result Value: {self.result_value}, Context: {self.context}"

    def __repr__(self):
        return f"ResultTableRecord({self.experiment_id}, {self.result_type}, {self.result_value}, {self.context})"

    def __eq__(self, other):
        return (
            self.experiment_id == other.experiment_id
            and self.result_type == other.result_type
            and self.result_value == other.result_value
            and self.context == other.context
        )

    def __ne__(self, other):
        return not self.__eq__(other)

    def __hash__(self):
        return hash(
            (self.experiment_id, self.result_type, self.result_value, self.context)
        )

    def __iter__(self):
        yield self.experiment_id
        yield self.result_type
        yield self.result_value
        yield self.context

    def __list__(self):
        return [self.experiment_id, self.result_type, self.result_value, self.context]


@dataclass(config=ConfigDict(validate_assignment=True))
class ExperimentResult:
    """Define the data that is generated by an experiment"""

    experiment_id: int = None
    well_id: str = None

    # OCP CA
    ocp_ca_file: List[Tuple[Path, str]] = field(default_factory=list)
    ocp_ca_passed: List[Tuple[bool, str]] = field(default_factory=list)
    ocp_ca_data: List[Tuple[str, str]] = field(default_factory=list)

    # OCP CV
    ocp_cv_file: List[Tuple[Path, str]] = field(default_factory=list)
    ocp_cv_passed: List[Tuple[bool, str]] = field(default_factory=list)
    ocp_cv_data: List[Tuple[str, str]] = field(default_factory=list)
    ocp_cv_final_voltage: List[Tuple[float, str]] = field(default_factory=list)

    # CA
    ca_data_file: List[Tuple[Path, str]] = field(default_factory=list)
    ca_data: List[Tuple[str, str]] = field(default_factory=list)

    # CV
    cv_data_file: List[Tuple[Path, str]] = field(default_factory=list)
    cv_data: List[Tuple[str, str]] = field(default_factory=list)

    # Images
    images: List[Tuple[Path, str]] = field(default_factory=list)

    def set_ocp_ca_file(
        self, file: Path, passed: bool, final_voltage: float, context: str = None
    ):
        """Set the file, the pass/fail status, and the final voltage"""
        self.ocp_ca_file.append((file, context))
        self.ocp_ca_passed.append((passed, context))
        self.ocp_cv_final_voltage.append((final_voltage, context))

        with open(file, "r") as f:
            # Save the contents of the file (it will be text) into the data list as one index of the list
            self.ocp_ca_data.append((f.read(), context))

    def set_ocp_cv_file(
        self, file: Path, passed: bool, final_voltage: float, context: str = None
    ):
        """Set the file, the pass/fail status, and the final voltage"""
        self.ocp_cv_file.append((file, context))
        self.ocp_cv_passed.append((passed, context))
        self.ocp_cv_final_voltage.append((final_voltage, context))

        with open(file, "r") as f:
            # Save the contents of the file (it will be text) into the data list as one index of the list
            self.ocp_cv_data.append((f.read(), context))

    def set_ca_data_file(
        self,
        file: Path,
        context: str = None,
    ):
        """Set the file, the plot file, the max value, and the min value"""
        self.ca_data_file.append((file, context))

        with open(file, "r") as f:
            # Save the contents of the file (it will be text) into the data list as one index of the list
            self.ca_data.append((f.read(), context))

    def set_cv_data_file(
        self,
        file: Path,
        context: str = None,
    ):
        """Set the file, the plot file, the max value, and the min value"""
        self.cv_data_file.append((file, context))

        with open(file, "r") as f:
            # Save the contents of the file (it will be text) into the data list as one index of the list
            self.cv_data.append((f.read(), context))

    def append_image_file(self, file: Path, context: str = None):
        """Append the image file"""
        self.images.append((file, context))

    def one_to_many(self) -> list[ExperimentResultsRecord]:
        """Turn the results object into individual result table records"""
        all_results = []
        for key, value in self.__dict__.items():
            if key in ["experiment_id", "well_id", "pumping_record"]:
                continue
            if isinstance(value, list):
                for _, item in enumerate(value):
                    all_results.append(
                        ExperimentResultsRecord(
                            self.experiment_id, key, item[0], item[1]
                        )
                    )
            else:
                all_results.append(
                    ExperimentResultsRecord(self.experiment_id, key, value)
                )
        return all_results

    def to_results_records(self) -> list[ExperimentResultsRecord]:
        """Turn the results object into individual result table records"""
        all_results = []
        for key, value in self.__dict__.items():
            if key in ["experiment_id", "well_id", "pumping_record"]:
                continue
            if isinstance(value, list):
                for _, item in enumerate(value):
                    all_results.append(
                        ExperimentResultsRecord(
                            self.experiment_id, key, item[0], item[1]
                        )
                    )
            else:
                all_results.append(
                    ExperimentResultsRecord(self.experiment_id, key, value)
                )
        return all_results


def parse_results(json_string: str) -> ExperimentResult:
    """Parse an experiment result from a json string"""
    return RootModel[ExperimentResult].model_validate_json(json_string).root


def serialize_results(results: ExperimentResult) -> str:
    """Serialize an experiment result to a json string"""
    return RootModel[ExperimentResult](results).model_dump_json(indent=4)


def insert_experiment_result(entry: ExperimentResultsRecord) -> None:
    """
    Insert an entry into the result table.

    Args:
        entry (ResultTableEntry): The entry to insert.
    """

    with SessionLocal() as session:
        if isinstance(entry.result_value, Path):
            # Turn the Path object into a string
            entry.result_value = str(entry.result_value)
        session.add(
            ExperimentResults(
                experiment_id=entry.experiment_id,
                result_type=entry.result_type,
                result_value=entry.result_value,
                context=entry.context,
            )
        )
        session.commit()


def insert_experiment_results(entries: List[ExperimentResultsRecord]) -> None:
    """
    Insert a list of entries into the result table.

    Args:
        entries (List[ResultTableEntry]): The entries to insert.
    """
    for entry in entries:
        insert_experiment_result(entry)


def select_results(experiment_id: int) -> List[ExperimentResultsRecord]:
    """
    Select the entries from the result table that are associated with an experiment.

    Args:
        experiment_id (int): The experiment ID.

    Returns:
        List[ResultTableEntry]: The entries from the result table.
    """
    # result_parameters = execute_sql_command(
    #     """
    #     SELECT
    #         experiment_id,
    #         result_type,
    #         result_value,
    #         context
    #     FROM experiment_results
    #     WHERE experiment_id = ?
    #     """,
    #     (experiment_id,),
    # )
    results = []
    with SessionLocal() as session:
        result = (
            session.query(ExperimentResults)
            .filter(ExperimentResults.experiment_id == experiment_id)
            .all()
        )

    for row in result:
        results.append(
            ExperimentResultsRecord(
                experiment_id=row.experiment_id,
                result_type=row.result_type,
                result_value=row.result_value,
                context=row.context,
            )
        )
    return results


def select_specific_result(
    experiment_id: int, result_type: str, context: Union[None, str] = None
) -> Union[List[ExperimentResultsRecord], ExperimentResultsRecord]:
    """
    Select a specific entry from the result table that is associated with an experiment.

    Args:
        experiment_id (int): The experiment ID.
        result_type (str): The result type.

    Returns:
        ResultTableEntry: The entry from the result table.
    """

    with SessionLocal() as session:
        if context is None:
            result = (
                session.query(ExperimentResults)
                .filter(ExperimentResults.experiment_id == experiment_id)
                .filter(ExperimentResults.result_type == result_type)
                .all()
            )
        else:
            result = (
                session.query(ExperimentResults)
                .filter(ExperimentResults.experiment_id == experiment_id)
                .filter(ExperimentResults.result_type == result_type)
                .filter(ExperimentResults.context == context)
                .all()
            )

    if not result:
        return None

    results = []
    for row in result:
        results.append(
            ExperimentResultsRecord(
                row.experiment_id, row.result_type, row.result_value, row.context
            )
        )

    if len(results) == 1:
        return results[0]

    return results
